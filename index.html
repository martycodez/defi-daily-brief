<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=5.0">
<title>Clover Capital â€” Portfolio Dashboard</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=DM+Sans:ital,opsz,wght@0,9..40,300;0,9..40,400;0,9..40,500;0,9..40,600;0,9..40,700;0,9..40,800;1,9..40,400&family=JetBrains+Mono:wght@400;500;600&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>
<style>
*,*::before,*::after{margin:0;padding:0;box-sizing:border-box}
html{-webkit-text-size-adjust:100%;scroll-behavior:smooth;overflow-x:hidden}
body{background:#0B1120;color:#E2E8F0;font-family:'DM Sans',sans-serif;overflow-x:hidden;-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale;min-height:100vh}
::-webkit-scrollbar{width:5px;height:5px}::-webkit-scrollbar-track{background:transparent}::-webkit-scrollbar-thumb{background:#334155;border-radius:4px}
.container{max-width:1280px;margin:0 auto;padding:32px 24px}
.header{display:flex;align-items:center;justify-content:space-between;margin-bottom:32px;flex-wrap:wrap;gap:14px}
.header-left{display:flex;align-items:center;gap:14px}
.logo{width:40px;height:40px;background:linear-gradient(135deg,#4ADE80,#22D3EE);border-radius:10px;display:flex;align-items:center;justify-content:center;font-weight:800;font-size:18px;color:#0B1120}
.brand{font-size:22px;font-weight:700;color:#F1F5F9;letter-spacing:-0.5px}.brand span{color:#4ADE80}
.status-pill{display:flex;align-items:center;gap:6px;background:rgba(74,222,128,0.1);border:1px solid rgba(74,222,128,0.2);border-radius:20px;padding:6px 14px;font-size:11px;color:#4ADE80;font-family:'JetBrains Mono',monospace}
.status-dot{width:6px;height:6px;background:#4ADE80;border-radius:50%;animation:pulse 2s ease-in-out infinite}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:0.4}}
.last-update{font-size:11px;color:#596882;font-family:'JetBrains Mono',monospace}
.tabs{display:flex;gap:6px;overflow-x:auto;scrollbar-width:none;padding-bottom:3px;margin-bottom:24px}.tabs::-webkit-scrollbar{display:none}
.tab-btn{background:rgba(30,41,59,0.5);border:1px solid rgba(148,163,184,0.1);color:#94A3B8;padding:10px 20px;border-radius:12px;font-size:13px;font-weight:500;font-family:'DM Sans',sans-serif;cursor:pointer;transition:all .2s;white-space:nowrap}
.tab-btn:hover{background:rgba(30,41,59,0.8);color:#CBD5E1}
.tab-btn.active{background:rgba(74,222,128,0.1);border-color:rgba(74,222,128,0.3);color:#4ADE80}
.card{background:rgba(15,23,42,0.6);border:1px solid rgba(148,163,184,0.08);border-radius:16px;padding:24px;backdrop-filter:blur(10px)}
.hero-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:14px;margin-bottom:24px}
.hero-card{background:linear-gradient(135deg,rgba(15,23,42,0.8),rgba(30,41,59,0.4));border:1px solid rgba(148,163,184,0.08);border-radius:16px;padding:20px;position:relative;overflow:hidden}
.hero-card::after{content:'';position:absolute;top:0;left:0;right:0;height:2px}
.hero-card:nth-child(1)::after{background:linear-gradient(90deg,#4ADE80,#22D3EE)}
.hero-card:nth-child(2)::after{background:linear-gradient(90deg,#F7931A,#FCD34D)}
.hero-card:nth-child(3)::after{background:linear-gradient(90deg,#8B5CF6,#A78BFA)}
.hero-card:nth-child(4)::after{background:linear-gradient(90deg,#3B82F6,#60A5FA)}
.hero-label{font-size:11px;color:#596882;font-family:'JetBrains Mono',monospace;text-transform:uppercase;letter-spacing:1px;margin-bottom:8px}
.hero-value{font-size:34px;font-weight:800;color:#F1F5F9;letter-spacing:-1px;line-height:1.1}
.hero-sub{font-size:11px;color:#596882;margin-top:6px;font-family:'JetBrains Mono',monospace}
.hero-delta{font-size:12px;font-weight:600;margin-top:4px}.delta-neg{color:#F87171}.delta-pos{color:#4ADE80}
.metrics-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:10px;margin-bottom:24px}
.metric-box{background:rgba(15,23,42,0.4);border:1px solid rgba(148,163,184,0.06);border-radius:12px;padding:14px}
.metric-label{font-size:10px;color:#596882;font-family:'JetBrains Mono',monospace;text-transform:uppercase;letter-spacing:0.5px;margin-bottom:4px}
.metric-value{font-size:18px;font-weight:700;color:#F1F5F9}
.content-grid{display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-bottom:24px}
.section-title{font-size:16px;font-weight:700;color:#F1F5F9;margin-bottom:16px;display:flex;align-items:center;gap:8px}
.tbl-wrap{overflow-x:auto}
table{width:100%;border-collapse:collapse;min-width:520px;font-size:13px}
th{text-align:left;padding:10px 12px;color:#596882;font-weight:500;font-size:11px;text-transform:uppercase;letter-spacing:0.5px;border-bottom:1px solid rgba(148,163,184,0.1);font-family:'JetBrains Mono',monospace}
td{padding:10px 12px;border-bottom:1px solid rgba(148,163,184,0.05);color:#CBD5E1}
tr:hover td{background:rgba(30,41,59,0.3)}.tbl-bold td{font-weight:600;color:#F1F5F9}
.itd-qtd{display:grid;grid-template-columns:1fr 1fr}
.itd-qtd>div:first-child{border-right:1px solid rgba(148,163,184,0.1);padding-right:24px}
.itd-qtd>div:last-child{padding-left:24px}
.period-label{font-size:11px;color:#596882;font-family:'JetBrains Mono',monospace;text-transform:uppercase;letter-spacing:1px;margin-bottom:6px}
.return-row{display:flex;justify-content:space-between;align-items:center;padding:8px 0;border-bottom:1px solid rgba(148,163,184,0.05)}
.return-row:last-child{border-bottom:none}
.return-label{font-size:13px;color:#94A3B8}.return-value{font-size:14px;font-weight:600}
.chart-container{position:relative;height:320px;margin-top:12px}
.chart-legend{display:flex;gap:16px;margin-bottom:12px;flex-wrap:wrap}
.legend-item{display:flex;align-items:center;gap:6px;font-size:12px;color:#94A3B8}
.legend-swatch{width:18px;height:4px;border-radius:2px}
.alloc-bar-row{display:flex;align-items:center;gap:12px;margin-bottom:10px}
.alloc-label{width:60px;font-size:12px;color:#94A3B8;font-family:'JetBrains Mono',monospace;flex-shrink:0}
.alloc-bar-track{flex:1;height:28px;background:rgba(30,41,59,0.4);border-radius:6px;overflow:hidden}
.alloc-bar-fill{height:100%;border-radius:6px;display:flex;align-items:center;padding:0 10px;font-size:11px;font-weight:600;color:#0B1120;transition:width 0.6s ease}
.alloc-pct{font-size:12px;color:#94A3B8;font-family:'JetBrains Mono',monospace;width:50px;text-align:right;flex-shrink:0}
.cost-bar-row{display:flex;align-items:center;gap:8px;margin-bottom:8px}
.cost-bar-label{width:100px;font-size:11px;color:#94A3B8;font-family:'JetBrains Mono',monospace;flex-shrink:0;text-align:right}
.cost-bar-track{flex:1;height:24px;background:rgba(30,41,59,0.3);border-radius:4px;overflow:hidden;position:relative}
.cost-bar-fill{height:100%;border-radius:4px;display:flex;align-items:center;justify-content:flex-end;padding:0 8px;font-size:10px;font-weight:600;color:#fff}
.tab-content{display:none}.tab-content.active{display:block}
.loading-overlay{position:fixed;inset:0;background:rgba(11,17,32,0.9);display:flex;flex-direction:column;align-items:center;justify-content:center;z-index:1000;transition:opacity 0.4s}
.loading-overlay.hidden{opacity:0;pointer-events:none}
.loading-spinner{width:40px;height:40px;border:3px solid rgba(74,222,128,0.2);border-top-color:#4ADE80;border-radius:50%;animation:spin 0.8s linear infinite}
@keyframes spin{to{transform:rotate(360deg)}}
.loading-text{margin-top:16px;font-size:13px;color:#596882;font-family:'JetBrains Mono',monospace}
.error-banner{background:rgba(248,113,113,0.1);border:1px solid rgba(248,113,113,0.2);border-radius:10px;padding:10px 16px;margin-bottom:16px;font-size:12px;color:#F87171;display:none;font-family:'JetBrains Mono',monospace}
.commentary{background:rgba(30,41,59,0.3);border-radius:10px;padding:16px;font-size:13px;color:#94A3B8;line-height:1.6;margin-top:12px}
.commentary strong{color:#F1F5F9}.commentary .g{color:#4ADE80;font-weight:700}.commentary .o{color:#F7931A;font-weight:700}
@media(max-width:1024px){.hero-grid{grid-template-columns:repeat(2,1fr)}}
@media(max-width:768px){
.header{flex-direction:column;align-items:stretch;gap:14px;margin-bottom:20px}
.tab-btn{padding:8px 14px;font-size:13px;border-radius:10px}
.card{padding:16px;border-radius:14px}
.hero-grid{grid-template-columns:repeat(2,1fr);gap:10px}
.metrics-grid{grid-template-columns:repeat(2,1fr);gap:8px}
.content-grid{grid-template-columns:1fr}
.itd-qtd{grid-template-columns:1fr}
.itd-qtd>div:first-child{border-right:none;border-bottom:1px solid rgba(148,163,184,0.1);padding-bottom:24px;padding-right:0;margin-bottom:8px}
.itd-qtd>div:last-child{padding-left:0}
.cost-bar-label{width:80px;font-size:10px}
.container{padding-left:14px;padding-right:14px}
.chart-container{height:250px}
.hero-value{font-size:26px}
}
</style>
</head>
<body>
<div class="loading-overlay" id="loadingOverlay"><div class="loading-spinner"></div><div class="loading-text">Loading portfolio data...</div></div>
<div class="container">
<div class="error-banner" id="errorBanner"></div>
<div class="header">
<div class="header-left"><div class="logo">C</div><div><div class="brand">Clover <span>Capital</span></div><div class="last-update" id="lastUpdate">Loading...</div></div></div>
<div style="display:flex;align-items:center;gap:10px"><div class="status-pill"><div class="status-dot"></div><span>LIVE</span></div><div id="countdown" style="font-size:10px;color:#596882;font-family:'JetBrains Mono',monospace">60s</div></div>
</div>
<div class="tabs" id="tabBar">
<button class="tab-btn active" data-tab="overview">Overview</button>
<button class="tab-btn" data-tab="performance">Performance</button>
<button class="tab-btn" data-tab="allocation">Allocation</button>
<button class="tab-btn" data-tab="tranches">Purchases</button>
</div>
<div class="hero-grid">
<div class="hero-card"><div class="hero-label">Total AUM</div><div class="hero-value" id="heroAUM">â€”</div><div class="hero-delta" id="heroAUMDelta"></div></div>
<div class="hero-card"><div class="hero-label">BTC Holdings</div><div class="hero-value" id="heroBTC">â€”</div><div class="hero-sub" id="heroBTCPrice"></div></div>
<div class="hero-card"><div class="hero-label">Inception to Date</div><div class="hero-value" id="heroITD">â€”</div><div class="hero-sub">Time-Weighted Return</div></div>
<div class="hero-card"><div class="hero-label">ITD Alpha vs BTC</div><div class="hero-value" id="heroAlpha">â€”</div><div class="hero-sub">Fund âˆ’ BTC Benchmark</div></div>
</div>
<!-- OVERVIEW -->
<div class="tab-content active" id="tab-overview">
<div class="metrics-grid">
<div class="metric-box"><div class="metric-label">Days Since Inception</div><div class="metric-value" id="metDays">â€”</div></div>
<div class="metric-box"><div class="metric-label">Max Drawdown</div><div class="metric-value" id="metDrawdown">â€”</div></div>
<div class="metric-box"><div class="metric-label">BTC Exposure</div><div class="metric-value" id="metBTCExposure">â€”</div></div>
<div class="metric-box"><div class="metric-label">Cash + Stables</div><div class="metric-value" id="metCash">â€”</div></div>
</div>
<div class="card" style="margin-bottom:24px">
<div class="section-title">ğŸ“Š Fund vs BTC (Time-Weighted Returns)</div>
<div class="itd-qtd">
<div><div class="period-label">Inception to Date</div>
<div class="return-row"><span class="return-label">Fund TWR</span><span class="return-value" id="itdFund">â€”</span></div>
<div class="return-row"><span class="return-label">BTC Benchmark</span><span class="return-value" id="itdBTC">â€”</span></div>
<div class="return-row"><span class="return-label" style="color:#4ADE80">Alpha</span><span class="return-value" id="itdAlpha" style="color:#4ADE80">â€”</span></div>
<div class="return-row"><span class="return-label">ITD P&L ($)</span><span class="return-value" id="itdPnL">â€”</span></div>
</div>
<div><div class="period-label">Quarter to Date</div>
<div class="return-row"><span class="return-label">Fund TWR</span><span class="return-value" id="qtdFund">â€”</span></div>
<div class="return-row"><span class="return-label">BTC Benchmark</span><span class="return-value" id="qtdBTC">â€”</span></div>
<div class="return-row"><span class="return-label" style="color:#4ADE80">Alpha</span><span class="return-value" id="qtdAlpha" style="color:#4ADE80">â€”</span></div>
<div class="return-row"><span class="return-label">QTD P&L ($)</span><span class="return-value" id="qtdPnL">â€”</span></div>
</div></div></div>
<div class="card" style="margin-bottom:24px">
<div class="section-title">ğŸ“ˆ Portfolio vs BTC (ITD TWR)</div>
<div class="chart-legend">
<div class="legend-item"><div class="legend-swatch" style="background:#4ADE80"></div>Fund TWR</div>
<div class="legend-item"><div class="legend-swatch" style="background:#F7931A"></div>BTC TWR</div>
<div class="legend-item"><div class="legend-swatch" style="background:#8B5CF6"></div>BTC Price</div>
</div>
<div class="chart-container"><canvas id="twrChart"></canvas></div>
</div>
<div class="card" style="margin-bottom:24px">
<div class="section-title">ğŸ’¡ Portfolio Commentary</div>
<div class="commentary" id="commentary">Loading...</div>
</div>
<div class="card"><div class="section-title">ğŸ“‰ Drawdown from Peak</div><div class="chart-container"><canvas id="drawdownChart"></canvas></div></div>
</div>
<!-- PERFORMANCE -->
<div class="tab-content" id="tab-performance">
<div class="card" style="margin-bottom:24px">
<div class="section-title">ğŸ’° Fund vs BTC (Money-Weighted Returns)</div>
<div class="tbl-wrap"><table><thead><tr><th>Component</th><th>QTD PnL ($)</th><th>QTD Return</th><th>ITD PnL ($)</th><th>ITD Return</th></tr></thead><tbody id="mwrBody"></tbody></table></div>
</div>
<div class="card" style="margin-bottom:24px">
<div class="section-title">ğŸ“‹ Key Metrics</div>
<div id="keyMetricsDetail" style="display:grid;grid-template-columns:1fr 1fr;gap:10px"></div>
</div>
<div class="card">
<div class="section-title">â‚¿ BTC Benchmark (TWR)</div>
<div class="tbl-wrap"><table><thead><tr><th>Metric</th><th>QTD PnL ($)</th><th>QTD Return</th><th>ITD PnL ($)</th><th>ITD Return</th></tr></thead><tbody id="btcTwrBody"></tbody></table></div>
</div>
</div>
<!-- ALLOCATION -->
<div class="tab-content" id="tab-allocation">
<div class="content-grid">
<div class="card"><div class="section-title">ğŸ¦ Asset Allocation</div><div id="allocBars"></div></div>
<div class="card"><div class="section-title">ğŸ“Š Breakdown</div><div class="tbl-wrap"><table><thead><tr><th>Asset</th><th>Amount</th><th>Price</th><th>AUM</th><th>%</th></tr></thead><tbody id="allocTable"></tbody></table></div></div>
</div>
<div class="card" style="margin-top:16px"><div class="section-title">ğŸ›ï¸ By Venue</div><div class="tbl-wrap"><table><thead><tr><th>Asset</th><th>Venue</th><th>Amount</th><th>Price</th><th>Value</th></tr></thead><tbody id="venueTable"></tbody></table></div></div>
</div>
<!-- PURCHASES -->
<div class="tab-content" id="tab-tranches">
<div class="card" style="margin-bottom:24px">
<div class="section-title">ğŸ’ BTC Purchase Cost Basis</div><div id="costBars"></div>
<div style="margin-top:12px;display:flex;gap:16px;font-size:11px;font-family:'JetBrains Mono',monospace">
<div style="display:flex;align-items:center;gap:6px"><div style="width:12px;height:12px;background:#F7931A;border-radius:2px"></div><span style="color:#94A3B8">Avg Cost: <span id="avgCostLabel" style="color:#F1F5F9">â€”</span></span></div>
<div style="display:flex;align-items:center;gap:6px"><div style="width:12px;height:3px;background:#4ADE80;border-radius:2px"></div><span style="color:#94A3B8">BTC Price: <span id="btcPriceLabel" style="color:#F1F5F9">â€”</span></span></div>
</div></div>
<div class="card" style="margin-bottom:24px"><div class="section-title">ğŸ“ Purchase History</div><div class="tbl-wrap"><table><thead><tr><th>Trade</th><th>Qty (BTC)</th><th>Avg Price</th><th>Date</th><th>Value</th></tr></thead><tbody id="purchaseTable"></tbody></table></div></div>
<div class="card" style="margin-bottom:24px"><div class="section-title">ğŸ’µ Capital Inflows</div><div class="tbl-wrap"><table><thead><tr><th>Stakeholder</th><th>Person</th><th>Asset</th><th>Quantity</th><th>Value</th><th>Date</th></tr></thead><tbody id="inflowsTable"></tbody></table></div></div>
<div class="card"><div class="section-title">ğŸ“ˆ BTC Holdings Over Time</div>
<div class="chart-legend"><div class="legend-item"><div class="legend-swatch" style="background:#4ADE80"></div>Holdings</div><div class="legend-item"><div class="legend-swatch" style="background:#8B5CF6"></div>BTC Price</div></div>
<div class="chart-container"><canvas id="holdingsChart"></canvas></div></div>
</div>
</div>
<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CONFIG â€” Using TWO fetch strategies for maximum reliability
// Strategy 1: Published CSV (pub?output=csv) â€” primary
// Strategy 2: Google Visualization API (gviz/tq) â€” fallback
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const SHEET_ID='1QiW-1REapN-UD76xTf5ne4P-J6cWvMPJuuVqaYATFk0';
const PUB_ID='2PACX-1vRwRHNmvnfYRYB3LRuUpLd2pt8R-RSSYYqU2DZ_QUoNRzFW0NmzZ2OsICbxX1xYc9l4ChniUmdwhDbF';
const GIDS={dashboard:163729112,perfSummary:828103600,returnsDaily:1053773100,purchases:1222270502};
const REFRESH=60000,INCEPTION_AUM=33770670.78,INCEPTION_BTC=90287.49;
let lastGood=null,charts={};

// Primary: Published CSV URL
function pubCsvUrl(gid){
  return 'https://docs.google.com/spreadsheets/d/e/'+PUB_ID+'/pub?gid='+gid+'&single=true&output=csv&_t='+Date.now();
}
// Fallback: Google Visualization API (works with "Anyone with link" sharing)
function gvizUrl(gid){
  return 'https://docs.google.com/spreadsheets/d/'+SHEET_ID+'/gviz/tq?tqx=out:csv&gid='+gid+'&_t='+Date.now();
}

async function fetchCSV(gid){
  let text;
  // Try primary URL first
  try{
    const r=await fetch(pubCsvUrl(gid),{redirect:'follow',cache:'no-store'});
    if(r.ok){text=await r.text();if(text&&text.length>10&&!text.includes('<!DOCTYPE'))return Papa.parse(text,{header:false,skipEmptyLines:true}).data}
  }catch(e){console.warn('Primary fetch failed for gid '+gid+':',e.message)}
  // Fallback to gviz
  try{
    const r=await fetch(gvizUrl(gid),{redirect:'follow',cache:'no-store'});
    if(r.ok){text=await r.text();if(text&&text.length>10)return Papa.parse(text,{header:false,skipEmptyLines:true}).data}
  }catch(e){console.warn('Fallback fetch failed for gid '+gid+':',e.message)}
  throw new Error('Both fetch methods failed for tab '+gid);
}

// Parsing helpers
function pN(s){if(!s||s==='-'||s==='')return null;return parseFloat(String(s).replace(/[$,%()]/g,'').replace(/\s/g,''))}
function pP(s){if(!s||s==='-'||s==='')return null;let v=String(s).replace(/[+\s]/g,'');const neg=v.includes('(')||v.startsWith('-');v=v.replace(/[$,%()"-]/g,'');let n=parseFloat(v);if(isNaN(n))return null;if(neg&&n>0)n=-n;if(String(s).includes('%'))return n/100;return n}
function pD(s){if(!s||s==='-'||s==='')return null;let t=String(s).replace(/[$,\s"]/g,'');if(t.startsWith('(')&&t.endsWith(')'))t='-'+t.slice(1,-1);const n=parseFloat(t);return isNaN(n)?null:n}

// Formatting helpers
function fD(n,c){if(n==null||isNaN(n))return'\u2014';if(c&&Math.abs(n)>=1e6)return(n<0?'-':'')+'$'+(Math.abs(n)/1e6).toFixed(2)+'M';if(c&&Math.abs(n)>=1e3)return(n<0?'-':'')+'$'+(Math.abs(n)/1e3).toFixed(1)+'K';return n<0?'-$'+Math.abs(n).toLocaleString('en-US',{minimumFractionDigits:2,maximumFractionDigits:2}):'$'+n.toLocaleString('en-US',{minimumFractionDigits:2,maximumFractionDigits:2})}
function fP(n,d){d=d||2;if(n==null||isNaN(n))return'\u2014';return(n*100).toFixed(d)+'%'}
function fPR(n,d){d=d||2;if(n==null||isNaN(n))return'\u2014';return n.toFixed(d)+'%'}
function fN(n,d){d=d||2;if(n==null||isNaN(n))return'\u2014';return n.toLocaleString('en-US',{minimumFractionDigits:d,maximumFractionDigits:d})}
function cP(el,v){if(v!=null)el.style.color=v>=0?'#4ADE80':'#F87171'}
function cc(v){return(v||0)>=0?'#4ADE80':'#F87171'}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// PARSE EACH TAB
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function parseDashboard(R){
  const d={};
  d.aum=pD(R[4]?.[1]);d.btcPrice=pD(R[4]?.[4]);d.btcHoldings=pN(R[4]?.[7]);
  d.btcAvgCost=pD(R[5]?.[14]);d.btcAvgPurchasePrice=pD(R[6]?.[14]);
  d.twoFiveAUM=pD(R[7]?.[14]);d.mwrITD=pP(R[8]?.[14]);
  d.itdF=pP(R[10]?.[14]);d.itdB=pP(R[11]?.[14]);d.itdA=pP(R[12]?.[14]);
  d.qtdF=pP(R[14]?.[14]);d.qtdB=pP(R[15]?.[14]);d.qtdA=pP(R[16]?.[14]);
  d.mwr=[];
  for(let i=10;i<=15;i++)d.mwr.push({l:R[i]?.[1]||'',qp:pD(R[i]?.[2]),qr:pP(R[i]?.[4]),ip:pD(R[i]?.[6]),ir:pP(R[i]?.[8])});
  d.btcTWR={l:R[19]?.[1]||'BTC (ALL TWR)',qp:pD(R[19]?.[2]),qr:pP(R[19]?.[4]),ip:pD(R[19]?.[6]),ir:pP(R[19]?.[8])};
  d.assets=[];
  for(let i=23;i<=27;i++){const a=R[i]?.[1];if(!a)continue;d.assets.push({a:a,amt:pN(R[i]?.[2]),px:pD(R[i]?.[4]),aum:pD(R[i]?.[6]),pct:pN(R[i]?.[8]?.replace('%',''))/100})}
  d.venues=[];let ca='';
  for(let i=31;i<=44;i++){const r=R[i];if(!r)continue;const ac=r[1]?.trim(),vc=r[2]?.trim();if(ac&&ac!=='')ca=ac;if(vc&&vc!=='')d.venues.push({a:ca,v:vc,amt:r[4]||'',px:r[6]||'',val:r[8]||''});else if(ac)d.venues.push({a:ca,v:'(Total)',amt:r[4]||'',px:r[6]||'',val:r[8]||'',s:true})}
  return d;
}
function parsePerfSummary(R){
  const d={};d.days=pN(R[4]?.[4]);
  d.itdF=pP(R[8]?.[2]);d.itdB=pP(R[8]?.[3]);d.itdA=pP(R[8]?.[4]);
  d.inBTC=pD(R[10]?.[3]);d.curBTC=pD(R[11]?.[3]);
  d.itdPF=pD(R[12]?.[2]);d.itdPB=pD(R[12]?.[3]);d.itdPA=pD(R[12]?.[4]);
  d.qtdF=pP(R[16]?.[2]);d.qtdB=pP(R[16]?.[3]);d.qtdA=pP(R[16]?.[4]);
  d.qtdPF=pD(R[19]?.[2]);d.qtdPB=pD(R[19]?.[3]);
  d.aum=pD(R[22]?.[2]);d.capInv=pD(R[23]?.[2]);d.totPnL=pD(R[24]?.[2]);
  d.btcH=pN(R[25]?.[2]);d.btcPD=pD(R[28]?.[2]);
  return d;
}
function parseReturnsDaily(R){
  const d=[];
  for(let i=3;i<R.length;i++){
    const r=R[i];if(!r||!r[0])break;
    const tw=pN(r[4]?.replace('%','')),cw=pN(r[5]?.replace('%',''));
    if(cw==null&&tw==null)continue;
    d.push({dt:r[0],tw:tw,cw:cw,pv:pD(r[6]),gl:pD(r[7]),bh:pN(r[9]),bp:pD(r[10])});
  }
  return d;
}
function parsePurchases(R){
  const p=[],inf=[];
  for(let i=3;i<=20;i++){const r=R[i];if(!r||!r[1])break;p.push({desc:r[3],qty:pN(r[6]),basis:pD(r[7]),date:r[5],val:pD(r[8])})}
  for(let i=3;i<=20;i++){const r=R[i];if(!r||!r[10])break;inf.push({sh:r[10],per:r[11],ast:r[12],qty:r[13],val:r[15],dt:r[16]})}
  const st={};for(let i=2;i<=12;i++){const r=R[i];if(r&&r[18])st[r[18].trim()]=r[19]}
  return{p:p,inf:inf,st:st};
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// RENDER ALL
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderAll(dash,perf,rd,pu){
  // Hero cards
  const aum=perf.aum||dash.aum;
  document.getElementById('heroAUM').textContent=fD(aum,true);
  const ad=((aum-INCEPTION_AUM)/INCEPTION_AUM*100);
  const de=document.getElementById('heroAUMDelta');
  de.textContent=(ad>=0?'+':'')+ad.toFixed(1)+'% from '+fD(INCEPTION_AUM,true);
  de.className='hero-delta '+(ad>=0?'delta-pos':'delta-neg');
  document.getElementById('heroBTC').textContent=fN(dash.btcHoldings);
  document.getElementById('heroBTCPrice').textContent='BTC Price: '+fD(dash.btcPrice);
  const iv=perf.itdF||dash.itdF,hi=document.getElementById('heroITD');
  hi.textContent=fP(iv);cP(hi,iv);
  const av=perf.itdA||dash.itdA,ha=document.getElementById('heroAlpha');
  ha.textContent=(av>=0?'+':'')+fP(av);cP(ha,av);

  // Metrics strip
  document.getElementById('metDays').textContent=perf.days||'\u2014';
  if(rd.length){let pk=1,mx=0;for(const x of rd){const c=1+(x.cw||0)/100;if(c>pk)pk=c;const dd=(c-pk)/pk;if(dd<mx)mx=dd}
  const me=document.getElementById('metDrawdown');me.textContent=fPR(mx*100);me.style.color='#F87171'}
  const btcA=dash.assets.filter(function(a){return a.a==='BTC'||a.a==='WBTC'});
  const be=btcA.reduce(function(s,a){return s+(a.pct||0)},0);
  document.getElementById('metBTCExposure').textContent=fPR(be*100);document.getElementById('metBTCExposure').style.color='#F7931A';
  const cashA=dash.assets.filter(function(a){return a.a==='USDC'||a.a==='Cash'});
  const cp=cashA.reduce(function(s,a){return s+(a.pct||0)},0);
  document.getElementById('metCash').textContent=fPR(cp*100);document.getElementById('metCash').style.color='#22D3EE';

  // ITD/QTD returns
  function sv(id,v,ip){var e=document.getElementById(id);if(ip!==false){e.textContent=fP(v);cP(e,v)}else{e.textContent=fD(v);cP(e,v)}}
  sv('itdFund',perf.itdF||dash.itdF);sv('itdBTC',perf.itdB||dash.itdB);sv('itdAlpha',perf.itdA||dash.itdA);sv('itdPnL',perf.itdPF,false);
  sv('qtdFund',perf.qtdF||dash.qtdF);sv('qtdBTC',perf.qtdB||dash.qtdB);sv('qtdAlpha',perf.qtdA||dash.qtdA);sv('qtdPnL',perf.qtdPF,false);
  ['itdAlpha','qtdAlpha'].forEach(function(id){var e=document.getElementById(id);var raw=id==='itdAlpha'?(perf.itdA||dash.itdA):(perf.qtdA||dash.qtdA);if(raw!=null&&raw>0)e.style.color='#4ADE80'});

  // MWR Table
  var mb=document.getElementById('mwrBody');mb.innerHTML='';
  dash.mwr.forEach(function(r,i){if(!r.l)return;var tr=document.createElement('tr');if(i===0)tr.className='tbl-bold';
  tr.innerHTML='<td>'+r.l+'</td><td style="color:'+cc(r.qp)+'">'+fD(r.qp)+'</td><td style="color:'+cc(r.qr)+'">'+fP(r.qr)+'</td><td style="color:'+cc(r.ip)+'">'+fD(r.ip)+'</td><td style="color:'+cc(r.ir)+'">'+fP(r.ir)+'</td>';mb.appendChild(tr)});

  // BTC TWR row
  var bb=document.getElementById('btcTwrBody');bb.innerHTML='';var br=dash.btcTWR;var btr=document.createElement('tr');btr.className='tbl-bold';
  btr.innerHTML='<td>'+br.l+'</td><td style="color:'+cc(br.qp)+'">'+fD(br.qp)+'</td><td style="color:'+cc(br.qr)+'">'+fP(br.qr)+'</td><td style="color:'+cc(br.ip)+'">'+fD(br.ip)+'</td><td style="color:'+cc(br.ir)+'">'+fP(br.ir)+'</td>';bb.appendChild(btr);

  // Key Metrics Detail
  var km=document.getElementById('keyMetricsDetail');
  var items=[
    {l:'BTC Avg Cost (Portfolio)',v:fD(dash.btcAvgCost||pD(pu.st['Total Portfolio Average Cost']))},
    {l:'BTC Avg Purchase Price',v:fD(dash.btcAvgPurchasePrice||pD(pu.st['Average Purchase Price']))},
    {l:'Inception BTC Price',v:fD(perf.inBTC||INCEPTION_BTC)},
    {l:'Current BTC Price',v:fD(dash.btcPrice)},
    {l:'2.5% of AUM',v:fD(dash.twoFiveAUM)},
    {l:'MWR ITD Return',v:fP(dash.mwrITD)},
    {l:'Total Capital Invested',v:fD(perf.capInv)},
    {l:'Total P&L',v:fD(perf.totPnL)}
  ];
  km.innerHTML=items.map(function(i){return'<div class="metric-box"><div class="metric-label">'+i.l+'</div><div class="metric-value" style="font-size:15px">'+i.v+'</div></div>'}).join('');

  // Allocation Bars + Table
  var colors={BTC:'#F7931A',WBTC:'#8B5CF6',USDC:'#22D3EE',Cash:'#94A3B8',ETH:'#627EEA'};
  var ab=document.getElementById('allocBars');ab.innerHTML='';
  dash.assets.forEach(function(a){var ps=((a.pct||0)*100).toFixed(2),bw=Math.max(2,(a.pct||0)*100);
  ab.innerHTML+='<div class="alloc-bar-row"><div class="alloc-label">'+a.a+'</div><div class="alloc-bar-track"><div class="alloc-bar-fill" style="width:'+bw+'%;background:'+(colors[a.a]||'#4ADE80')+'">'+(bw>15?fD(a.aum,true):'')+'</div></div><div class="alloc-pct">'+ps+'%</div></div>'});
  var at=document.getElementById('allocTable');at.innerHTML='';
  dash.assets.forEach(function(a){var tr=document.createElement('tr');var dd=(a.a==='USDC'||a.a==='Cash')?2:(a.amt<1?4:2);tr.innerHTML='<td><span style="display:inline-block;width:8px;height:8px;border-radius:50%;background:'+(colors[a.a]||'#4ADE80')+';margin-right:6px"></span>'+a.a+'</td><td>'+fN(a.amt,dd)+'</td><td>'+fD(a.px)+'</td><td>'+fD(a.aum)+'</td><td>'+((a.pct||0)*100).toFixed(2)+'%</td>';at.appendChild(tr)});

  // Venues
  var vt=document.getElementById('venueTable');vt.innerHTML='';
  dash.venues.forEach(function(v){var tr=document.createElement('tr');if(v.s)tr.className='tbl-bold';tr.innerHTML='<td>'+(v.s?v.a:'')+'</td><td>'+(v.s?'':v.v)+'</td><td>'+v.amt+'</td><td>'+v.px+'</td><td>'+v.val+'</td>';vt.appendChild(tr)});

  // Purchases Table
  var pt=document.getElementById('purchaseTable');pt.innerHTML='';
  pu.p.forEach(function(p){var tr=document.createElement('tr');tr.innerHTML='<td>'+(p.desc||'')+'</td><td>'+fN(p.qty,4)+'</td><td>'+fD(p.basis)+'</td><td>'+(p.date||'')+'</td><td>'+fD(p.val)+'</td>';pt.appendChild(tr)});
  var it2=document.getElementById('inflowsTable');it2.innerHTML='';
  pu.inf.forEach(function(inf){var tr=document.createElement('tr');tr.innerHTML='<td>'+inf.sh+'</td><td>'+inf.per+'</td><td>'+inf.ast+'</td><td>'+inf.qty+'</td><td>'+inf.val+'</td><td>'+inf.dt+'</td>';it2.appendChild(tr)});

  // Cost Basis Bars
  var cb=document.getElementById('costBars');cb.innerHTML='';
  var allC=pu.p.map(function(p){return p.basis}).filter(function(x){return x!=null});
  var mx2=Math.max.apply(null,allC.concat([dash.btcPrice||0,INCEPTION_BTC]))*1.05;
  var bpp=((dash.btcPrice||0)/mx2)*100;
  pu.p.forEach(function(p){if(!p.basis)return;var w=(p.basis/mx2)*100;var above=p.basis>(dash.btcPrice||0);
  cb.innerHTML+='<div class="cost-bar-row"><div class="cost-bar-label">'+((p.desc||'').split(' - ')[0])+'</div><div class="cost-bar-track"><div class="cost-bar-fill" style="width:'+w+'%;background:'+(above?'rgba(248,113,113,0.6)':'rgba(74,222,128,0.6)')+'">'+fD(p.basis)+'</div><div style="position:absolute;left:'+bpp+'%;top:0;bottom:0;width:2px;background:#4ADE80;opacity:0.6"></div></div></div>'});
  document.getElementById('avgCostLabel').textContent=fD(dash.btcAvgCost);
  document.getElementById('btcPriceLabel').textContent=fD(dash.btcPrice);

  // Commentary
  var alpha2=perf.itdA||dash.itdA;var als=alpha2?(alpha2*100).toFixed(2):'?';
  var usdcF=dash.assets.find(function(a){return a.a==='USDC'});
  var usdcPct=usdcF?((usdcF.pct||0)*100).toFixed(0):'20';
  document.getElementById('commentary').innerHTML='The fund currently <strong>outperforms</strong> a pure BTC hold by <span class="g">+'+als+'%</span> ITD through disciplined TWAP execution and opportunistic limit orders during drawdowns. Key alpha drivers include systematic dollar-cost averaging below inception price and aggressive limit orders during sharp drawdowns (Feb 1 at <span class="o">$78.5K</span>, Feb 5 at <span class="o">$63.1K</span>). The portfolio maintains ~'+usdcPct+'% in stablecoins/cash for deployment flexibility.';

  // Charts
  renderTWR(rd);renderDD(rd);renderHold(rd);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CHARTS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function fmtDL(s){if(!s)return'';var d=new Date(s);return isNaN(d)?s:d.toLocaleDateString('en-US',{month:'short',day:'numeric'})}

var chartFont={family:"'JetBrains Mono',monospace",size:10};
var chartGrid={color:'rgba(148,163,184,0.06)'};
var ttBase={backgroundColor:'rgba(15,23,42,0.95)',titleColor:'#F1F5F9',bodyColor:'#CBD5E1',borderColor:'rgba(148,163,184,0.2)',borderWidth:1,padding:12,titleFont:{family:"'JetBrains Mono',monospace",size:11},bodyFont:{family:"'JetBrains Mono',monospace",size:11}};

function renderTWR(rd){
  var ctx=document.getElementById('twrChart').getContext('2d');
  if(charts.twr)charts.twr.destroy();
  var lb=[],fd=[],bd=[],pd=[];
  for(var i=0;i<rd.length;i++){var d=rd[i];lb.push(fmtDL(d.dt));fd.push(d.cw);if(d.bp){bd.push(((d.bp/INCEPTION_BTC)-1)*100);pd.push(d.bp)}else{bd.push(null);pd.push(null)}}
  charts.twr=new Chart(ctx,{type:'line',data:{labels:lb,datasets:[
    {label:'Fund TWR',data:fd,borderColor:'#4ADE80',backgroundColor:'rgba(74,222,128,0.05)',borderWidth:2,fill:true,tension:.3,pointRadius:0,pointHoverRadius:4,yAxisID:'y'},
    {label:'BTC TWR',data:bd,borderColor:'#F7931A',borderWidth:2,borderDash:[6,3],fill:false,tension:.3,pointRadius:0,pointHoverRadius:4,yAxisID:'y'},
    {label:'BTC Price',data:pd,borderColor:'#8B5CF6',borderWidth:1.5,fill:false,tension:.3,pointRadius:0,pointHoverRadius:4,yAxisID:'y1'}
  ]},options:{responsive:true,maintainAspectRatio:false,interaction:{mode:'index',intersect:false},plugins:{legend:{display:false},tooltip:Object.assign({},ttBase,{callbacks:{label:function(c){return c.datasetIndex===2?'BTC: $'+c.raw?.toLocaleString():c.dataset.label+': '+c.raw?.toFixed(2)+'%'}}})},scales:{x:{grid:chartGrid,ticks:{color:'#596882',font:chartFont,maxTicksLimit:12}},y:{position:'left',grid:chartGrid,ticks:{color:'#596882',font:chartFont,callback:function(v){return v+'%'}}},y1:{position:'right',grid:{display:false},ticks:{color:'#8B5CF6',font:chartFont,callback:function(v){return'$'+(v/1000).toFixed(0)+'K'}}}}}});
}

function renderDD(rd){
  var ctx=document.getElementById('drawdownChart').getContext('2d');
  if(charts.dd)charts.dd.destroy();
  var lb=[],dd=[];var pk=1;
  for(var i=0;i<rd.length;i++){var d=rd[i];lb.push(fmtDL(d.dt));var c=1+(d.cw||0)/100;if(c>pk)pk=c;dd.push(((c-pk)/pk)*100)}
  charts.dd=new Chart(ctx,{type:'line',data:{labels:lb,datasets:[{label:'Drawdown',data:dd,borderColor:'#F87171',backgroundColor:'rgba(248,113,113,0.1)',borderWidth:1.5,fill:true,tension:.3,pointRadius:0,pointHoverRadius:4}]},options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{display:false},tooltip:Object.assign({},ttBase,{bodyColor:'#F87171',callbacks:{label:function(c){return'Drawdown: '+c.raw?.toFixed(2)+'%'}}})},scales:{x:{grid:chartGrid,ticks:{color:'#596882',font:chartFont,maxTicksLimit:12}},y:{grid:chartGrid,ticks:{color:'#596882',font:chartFont,callback:function(v){return v+'%'}},max:0}}}});
}

function renderHold(rd){
  var ctx=document.getElementById('holdingsChart').getContext('2d');
  if(charts.hold)charts.hold.destroy();
  var lb=[],hd=[],pd=[];
  for(var i=0;i<rd.length;i++){var d=rd[i];lb.push(fmtDL(d.dt));hd.push(d.bh);pd.push(d.bp)}
  charts.hold=new Chart(ctx,{type:'line',data:{labels:lb,datasets:[
    {label:'Holdings',data:hd,borderColor:'#4ADE80',borderWidth:2,fill:false,tension:.3,pointRadius:0,yAxisID:'y'},
    {label:'BTC Price',data:pd,borderColor:'#8B5CF6',borderWidth:1.5,fill:false,tension:.3,pointRadius:0,yAxisID:'y1'}
  ]},options:{responsive:true,maintainAspectRatio:false,interaction:{mode:'index',intersect:false},plugins:{legend:{display:false},tooltip:Object.assign({},ttBase,{callbacks:{label:function(c){return c.datasetIndex===0?'Holdings: '+c.raw?.toFixed(2)+' BTC':'BTC: $'+c.raw?.toLocaleString()}}})},scales:{x:{grid:chartGrid,ticks:{color:'#596882',font:chartFont,maxTicksLimit:12}},y:{position:'left',grid:chartGrid,ticks:{color:'#4ADE80',font:chartFont,callback:function(v){return v.toFixed(0)+' BTC'}}},y1:{position:'right',grid:{display:false},ticks:{color:'#8B5CF6',font:chartFont,callback:function(v){return'$'+(v/1000).toFixed(0)+'K'}}}}}});
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// TABS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
document.getElementById('tabBar').addEventListener('click',function(e){
  var b=e.target.closest('.tab-btn');if(!b)return;
  document.querySelectorAll('.tab-btn').forEach(function(x){x.classList.remove('active')});
  b.classList.add('active');
  document.querySelectorAll('.tab-content').forEach(function(c){c.classList.remove('active')});
  var t=document.getElementById('tab-'+b.dataset.tab);if(t)t.classList.add('active');
});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// MAIN LOAD
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function loadAllData(){
  try{
    var results=await Promise.all([
      fetchCSV(GIDS.dashboard),
      fetchCSV(GIDS.perfSummary),
      fetchCSV(GIDS.returnsDaily),
      fetchCSV(GIDS.purchases)
    ]);
    var dash=parseDashboard(results[0]);
    var perf=parsePerfSummary(results[1]);
    var rd=parseReturnsDaily(results[2]);
    var pu=parsePurchases(results[3]);
    lastGood={dash:dash,perf:perf,rd:rd,pu:pu};
    renderAll(dash,perf,rd,pu);
    document.getElementById('lastUpdate').textContent='Updated '+new Date().toLocaleTimeString('en-US',{hour:'2-digit',minute:'2-digit',second:'2-digit'});
    document.getElementById('errorBanner').style.display='none';
  }catch(err){
    console.error('Fetch error:',err);
    var b=document.getElementById('errorBanner');
    b.textContent='\u26A0 Refresh failed: '+err.message+'. Retrying in 60s...';
    b.style.display='block';
    if(!lastGood)document.getElementById('lastUpdate').textContent='Failed to load \u2014 retrying...';
  }
  document.getElementById('loadingOverlay').classList.add('hidden');
}

async function init(){
  await loadAllData();
  var secs=60;
  setInterval(function(){
    secs--;
    if(secs<=0){secs=60;loadAllData()}
    document.getElementById('countdown').textContent=secs+'s';
  },1000);
}
init();
</script>
</body>
</html>
